<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - AI Resume Analyzer</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="icon" type="image/svg+xml" href="/static/images/favicon.svg">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
</head>
<body>
    <canvas id="particleCanvas"></canvas>

    <nav class="navbar">
        <div class="container nav-container">
            <div class="nav-brand">
                <span class="logo-icon">üß†</span>
                <span class="brand-name">ResumeAI</span>
            </div>
            <div class="nav-links">
                <a href="/" class="nav-link">Home</a>
                <a href="/dashboard" class="nav-link active">Dashboard</a>
                <a href="/compare" class="nav-link">Compare</a>
            </div>
        </div>
    </nav>

    <section class="dashboard-section">
        <div class="container">
            <div class="dashboard-header">
                <div class="header-content">
                    <h1 class="dashboard-title">Analytics Dashboard</h1>
                    <p class="dashboard-subtitle">Track your resume analysis performance and insights</p>
                </div>
                <div style="display: flex; gap: 12px;">
                    <a href="/" class="new-analysis-btn">
                        <span class="btn-icon">‚ûï</span>
                        <span>New Analysis</span>
                    </a>
                    <a href="/export-csv" class="new-analysis-btn" style="background: linear-gradient(135deg, #22c55e 0%, #10b981 100%);">
                        <span class="btn-icon">üìä</span>
                        <span>Export CSV</span>
                    </a>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon blue">üìä</div>
                    <div class="stat-content">
                        <div class="stat-value" data-value="{{ total }}">0</div>
                        <div class="stat-label">Total Analyses</div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon green">‚≠ê</div>
                    <div class="stat-content">
                        <div class="stat-value" data-value="{{ avg_score }}">0</div>
                        <div class="stat-label">Average Score</div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon purple">üéØ</div>
                    <div class="stat-content">
                        <div class="stat-value" data-value="{{ high_score }}">0</div>
                        <div class="stat-label">High Scores (80%+)</div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon orange">üìà</div>
                    <div class="stat-content">
                        <div class="stat-value" data-value="{{ mid_score }}">0</div>
                        <div class="stat-label">Good Scores (50-79%)</div>
                    </div>
                </div>
            </div>

            <div class="charts-container">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">Score Distribution</h3>
                        <p class="chart-subtitle">Breakdown of all resume scores</p>
                    </div>
                    <div class="chart-body">
                        <canvas id="scoreDistChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">Recent Scores</h3>
                        <p class="chart-subtitle">Last 10 analyses performance</p>
                    </div>
                    <div class="chart-body">
                        <canvas id="recentScoresChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="table-card">
                <div class="table-header">
                    <div class="table-title-section">
                        <h3 class="table-title">Recent Analyses</h3>
                        <span class="table-count">{{ total }} total</span>
                    </div>
                    <div class="table-search">
                        <input type="text" id="searchInput" placeholder="Search by filename or job title..." class="search-input">
                    </div>
                </div>

                <div class="table-container">
                    {% if analyses %}
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Resume</th>
                                <th>Job Title</th>
                                <th>Score</th>
                                <th>Keywords</th>
                                <th>Skills</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            {% for analysis in analyses %}
                            <tr data-id="{{ analysis.id }}">
                                <td>
                                    <div class="filename-cell">
                                        <span class="file-icon">üìÑ</span>
                                        <span class="filename">{{ analysis.filename }}</span>
                                    </div>
                                </td>
                                <td>
                                    <span class="job-title">{{ analysis.job_title or '‚Äî' }}</span>
                                </td>
                                <td>
                                    <div class="score-badge
                                        {% if analysis.score >= 80 %}score-high
                                        {% elif analysis.score >= 50 %}score-mid
                                        {% else %}score-low{% endif %}">
                                        {{ analysis.score }}%
                                    </div>
                                </td>
                                <td>
                                    <span class="metric-value">{{ analysis.keyword_score }}%</span>
                                </td>
                                <td>
                                    <span class="metric-value">{{ analysis.skills_score }}%</span>
                                </td>
                                <td>
                                    <span class="date-text">{{ analysis.created_at.strftime('%b %d, %Y') }}</span>
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <a href="/result/{{ analysis.uid }}" class="action-btn view" title="View Details">üëÅÔ∏è</a>
                                        <button class="action-btn delete" onclick="deleteAnalysis({{ analysis.id }})" title="Delete">üóëÔ∏è</button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <div class="empty-state">
                        <div class="empty-icon">üì≠</div>
                        <h3 class="empty-title">No analyses yet</h3>
                        <p class="empty-text">Upload your first resume to get started!</p>
                        <a href="/" class="empty-cta">Analyze Resume</a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </section>

    <footer class="footer">
        <div class="container">
            <p class="footer-text">
                Built by <strong>Hassan Ahmed</strong> ‚Äì AI Resume Analyzer
            </p>
            <p class="footer-tech">
                Powered by Flask ¬∑ Pure Python AI ¬∑ Neon DB
            </p>
        </div>
    </footer>

    <script src="/static/js/particles.js"></script>
    <script>
        const chartData = {{ recent_scores | safe }};
        const highScore = {{ high_score }};
        const midScore = {{ mid_score }};
        const lowScore = {{ low_score }};

        document.querySelectorAll('.stat-value').forEach(counter => {
            const target = parseInt(counter.getAttribute('data-value'));
            let current = 0;
            const increment = target / 30;
            const timer = setInterval(() => {
                current += increment;
                if (current >= target) {
                    counter.textContent = target;
                    clearInterval(timer);
                } else {
                    counter.textContent = Math.floor(current);
                }
            }, 30);
        });

        const distCtx = document.getElementById('scoreDistChart').getContext('2d');
        new Chart(distCtx, {
            type: 'doughnut',
            data: {
                labels: ['High (80%+)', 'Good (50-79%)', 'Needs Work (<50%)'],
                datasets: [{
                    data: [highScore, midScore, lowScore],
                    backgroundColor: ['#22c55e', '#f59e0b', '#ef4444'],
                    borderColor: '#0f172a',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { color: '#cbd5e1', padding: 20, font: { size: 12 } }
                    }
                }
            }
        });

        const scoresCtx = document.getElementById('recentScoresChart').getContext('2d');
        new Chart(scoresCtx, {
            type: 'bar',
            data: {
                labels: chartData.map(d => d.filename.substring(0, 15) + '...'),
                datasets: [{
                    label: 'Score',
                    data: chartData.map(d => d.score),
                    backgroundColor: chartData.map(d =>
                        d.score >= 80 ? '#22c55e' :
                        d.score >= 50 ? '#f59e0b' : '#ef4444'
                    ),
                    borderColor: '#0f172a',
                    borderWidth: 2,
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: { color: '#94a3b8' },
                        grid: { color: '#1e293b' }
                    },
                    x: {
                        ticks: { color: '#94a3b8' },
                        grid: { display: false }
                    }
                },
                plugins: { legend: { display: false } }
            }
        });

        document.getElementById('searchInput').addEventListener('input', function(e) {
            const search = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('#tableBody tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        });

        function deleteAnalysis(id) {
            if (!confirm('Delete this analysis? This cannot be undone.')) return;
            
            fetch(`/api/delete/${id}`, { method: 'DELETE' })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        const row = document.querySelector(`tr[data-id="${id}"]`);
                        row.style.opacity = '0';
                        row.style.transform = 'translateX(-20px)';
                        setTimeout(() => row.remove(), 300);
                    }
                })
                .catch(err => alert('Delete failed: ' + err));
        }
    </script>
</body>
</html>
